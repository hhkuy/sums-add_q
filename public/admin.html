<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full Auto Quiz Converter</title>
    <style>
        /* نفس تصميمك الأصلي مع تعديلات طفيفة */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 25px;
            color: #4a90e2;
        }
        .instructions {
            background-color: #eef6fc;
            padding: 20px;
            border-left: 6px solid #4a90e2;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        .instructions pre {
            background-color: #f9f9f9;
            padding: 15px;
            overflow: auto;
            border-radius: 5px;
            font-size: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            margin-top: 20px;
        }
        textarea, input[type="text"], input[type="number"], input[type="file"] {
            width: 100%;
            padding: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        textarea {
            height: 200px;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="file"]:focus {
            border-color: #4a90e2;
            outline: none;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        button {
            padding: 14px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-bottom: 10px;
            flex: 1 1 30%;
            margin-right: 10px;
        }
        button:last-child {
            margin-right: 0;
        }
        button:hover {
            transform: translateY(-3px);
        }
        #convertButton {
            background-color: #4a90e2;
            color: #fff;
        }
        #copyButton {
            background-color: #28a745;
            color: #fff;
        }
        #clearButton {
            background-color: #dc3545;
            color: #fff;
        }
        #outputSection {
            margin-top: 35px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 25px;
            border-radius: 6px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
        }
        .image-fields-container {
            margin-top: 20px;
        }
        .image-field-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .image-field-row input[type="number"] {
            width: 60px;
        }
        .image-field-row input[type="file"] {
            flex: 1;
        }
        .image-field-row button {
            width: auto;
            flex: 0 0 auto;
            background-color: #ff9800;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .progress {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
            margin-top: 5px;
        }
        .progress-bar {
            background-color: #4a90e2;
            height: 100%;
            width: 0%;
            text-align: center;
            color: #fff;
            line-height: 20px;
            transition: width 0.3s;
        }
        @media (max-width: 700px) {
            .button-group {
                flex-direction: column;
            }
            .button-group button {
                flex: 1 1 100%;
                margin-right: 0;
            }
        }

        /* قسم إدارة الـtopics.json */
        #topicsSection {
            margin-top: 40px;
            background: #eef6fc;
            padding: 20px;
            border-radius: 5px;
        }
        .topic-item {
            margin: 8px 0;
            background: #f9f9f9;
            border-radius: 4px;
            padding: 8px;
        }
        .subtopic-list {
            margin-left: 20px;
        }
        .subtopic-list li {
            margin: 4px 0;
        }
        .btn-del {
            background-color: #dc3545;
            color: #fff;
            margin-left: 5px;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #000;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Full Auto Quiz Converter</h1>
        <div class="instructions">
            <p>Please enter your questions in this format:</p>
            <pre>
1. Question text ...
A. Option ...
B. Option ...
C. Option ... ***
Explanation : any word
*** means correct answer
            </pre>
        </div>

        <!-- quiz converter inputs -->
        <label for="prefixInput">Enter Prefix (optional):</label>
        <input type="text" id="prefixInput" placeholder="e.g. Dr. Smith -">

        <label for="inputText">Enter Your Questions Here:</label>
        <textarea id="inputText" placeholder="Paste your questions here..."></textarea>

        <label>Add Images (optional):</label>
        <div class="image-fields-container" id="imageFieldsContainer"></div>
        <button type="button" onclick="addImageField()" style="background-color:#17a2b8; color:#fff; width:auto; margin-top:10px;">Add Image Field</button>

        <div class="button-group">
            <button id="convertButton" onclick="convertToQuizData()">Convert to quizData</button>
            <button id="copyButton" onclick="copyToClipboard()" disabled>Copy to Clipboard</button>
            <button id="clearButton" onclick="clearAll()">Clear All</button>
        </div>

        <!-- output code -->
        <div id="outputSection">
            <h2>Generated Code:</h2>
            <pre id="outputCode">// Your converted quizData will appear here...</pre>
        </div>

        <!-- ادارة topics.json -->
        <div id="topicsSection">
            <h2>Manage topics.json (Auto in data/)</h2>
            <button onclick="loadTopics()">Load topics.json</button>
            <button onclick="saveTopics()">Save topics.json</button>
            <div id="topicsResult" style="white-space:pre-wrap; background:#f9f9f9; padding:10px; margin-top:10px; border-radius:4px;"></div>
            <div id="topicsContainer"></div>

            <h3>Add New Topic</h3>
            <input type="text" id="newTopicName" placeholder="Topic Name...">
            <input type="text" id="newTopicDesc" placeholder="Topic Description...">
            <button onclick="addTopic()">Add Topic</button>
        </div>
    </div>

    <script>
        /* نفس الكود المذكور في الأجوبة السابقة */
        // ... [كل ما في الاجابات السابقة (uploadImageToServer, collectImageData, convertToQuizData, copyToClipboard, clearAll)]

        function addImageField() {
            const container = document.getElementById('imageFieldsContainer');
            const row = document.createElement('div');
            row.classList.add('image-field-row');

            const questionNumberInput = document.createElement('input');
            questionNumberInput.type = 'number';
            questionNumberInput.placeholder = 'Q#';
            questionNumberInput.min = 1;

            const imageFileInput = document.createElement('input');
            imageFileInput.type = 'file';
            imageFileInput.accept = 'image/*';

            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => {
                container.removeChild(row);
            };

            const progressContainer = document.createElement('div');
            progressContainer.classList.add('progress');
            progressContainer.style.display = 'none';
            const progressBar = document.createElement('div');
            progressBar.classList.add('progress-bar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressContainer.appendChild(progressBar);

            row.appendChild(questionNumberInput);
            row.appendChild(imageFileInput);
            row.appendChild(removeButton);
            row.appendChild(progressContainer);
            container.appendChild(row);
        }

        function uploadImageToServer(file, progressBarContainer, progressBar) {
            return new Promise((resolve) => {
                if (!file) return resolve("");

                if (progressBarContainer) progressBarContainer.style.display="block";
                if (progressBar) {
                    progressBar.style.width="0%";
                    progressBar.textContent="0%";
                }

                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/api/upload-image", true);
                xhr.setRequestHeader("Content-Type","application/json");

                xhr.upload.onprogress = function(e){
                    if (e.lengthComputable) {
                        let percent = Math.floor((e.loaded/e.total)*100);
                        if (progressBar) {
                            progressBar.style.width=percent+"%";
                            progressBar.textContent=percent+"%";
                        }
                    }
                };

                xhr.onload = function(){
                    if (xhr.status===200){
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success && response.url) {
                                if (progressBar) {
                                    progressBar.style.width="100%";
                                    progressBar.textContent="تم رفع الصورة";
                                }
                                return resolve(response.url);
                            } else {
                                if(progressBar) progressBar.textContent="فشل الرفع";
                                return resolve("");
                            }
                        }catch(err){
                            if(progressBar) progressBar.textContent="فشل الرفع";
                            return resolve("");
                        }
                    }else{
                        if(progressBar) progressBar.textContent="فشل الرفع";
                        resolve("");
                    }
                };

                xhr.onerror=()=>{
                    if(progressBar) progressBar.textContent="فشل الرفع";
                    resolve("");
                };

                // قراءة الملف Base64
                const reader=new FileReader();
                reader.onload=()=>{
                    const base64data=reader.result.split(",")[1];
                    xhr.send(JSON.stringify({
                        name:file.name,
                        base64:base64data
                    }));
                };
                reader.readAsDataURL(file);
            });
        }

        async function collectImageData() {
            const rows = document.querySelectorAll('.image-field-row');
            const data={};
            for(const row of rows){
                const inputs = row.querySelectorAll('input');
                const qNum = parseInt(inputs[0].value,10);
                if(!qNum) continue;
                const fileInput = inputs[1];
                if(fileInput.files && fileInput.files.length>0){
                    const file = fileInput.files[0];
                    const progressContainer = row.querySelector('.progress');
                    const progressBar= progressContainer.querySelector('.progress-bar');
                    const url = await uploadImageToServer(file,progressContainer,progressBar);
                    if(url){
                        if(!data[qNum]) data[qNum]=[];
                        data[qNum].push(url);
                    }
                }
            }
            return data;
        }

        async function convertToQuizData(){
            const input=document.getElementById('inputText').value;
            const prefix=document.getElementById('prefixInput').value.trim();
            const lines=input.split('\n');
            let questionText=null, options=[], correctAnswerIndex=null, answerText=null, explanation=null;
            let output=[];
            for(let i=0; i<lines.length; i++){
                let line=lines[i].trim();
                let qMatch=line.match(/^(\d+)\.\s+(.*)/);
                if(qMatch){
                    if(questionText!==null){
                        output.push({
                            question:questionText,
                            options,
                            answer:correctAnswerIndex,
                            answerText,
                            explanation,
                            userAnswer:null
                        });
                    }
                    let qNum=parseInt(qMatch[1],10);
                    questionText= `<span style='color: darkred; font-weight: bold;'>${prefix? prefix+' ':''}Question ${qNum}</span> ${qMatch[2]}`;
                    options=[];
                    correctAnswerIndex=null;
                    answerText=null;
                    explanation=null;
                } else {
                    let opt=line.match(/^([A-F])\.\s+(.*)/i);
                    if(opt){
                        let txt=opt[2].trim();
                        if(txt.endsWith('***')){
                            txt=txt.slice(0,-3).trim();
                            correctAnswerIndex=options.length;
                            answerText=txt;
                        }
                        options.push(txt);
                    } else {
                        let exp=line.match(/^Explanation\s*:\s*(.*)/i);
                        if(exp){
                            explanation=exp[1];
                        }
                    }
                }
            }
            if(questionText!==null){
                output.push({
                    question:questionText,
                    options,
                    answer:correctAnswerIndex,
                    answerText,
                    explanation,
                    userAnswer:null
                });
            }
            const imageMap=await collectImageData();
            output.forEach(obj=>{
                const qm=obj.question.match(/Question\s+(\d+)/);
                if(qm){
                    const qn=parseInt(qm[1],10);
                    if(imageMap[qn]){
                        imageMap[qn].forEach(url=>{
                            obj.question+=`<br><img src='${url}' style='max-width: 100%; height:auto;'>`;
                        });
                    }
                }
            });
            const code='let quizData = '+JSON.stringify(output,null,4)+';';
            document.getElementById('outputCode').textContent=code;
            document.getElementById('copyButton').disabled=(code.trim()==='');
        }

        function copyToClipboard(){
            const code=document.getElementById('outputCode').textContent;
            if(!code)return;
            navigator.clipboard.writeText(code).then(()=>alert('Copied!'));
        }

        function clearAll(){
            if(confirm('Clear all?')){
                document.getElementById('prefixInput').value='';
                document.getElementById('inputText').value='';
                document.getElementById('outputCode').textContent='// Your converted quizData will appear here...';
                document.getElementById('copyButton').disabled=true;
                document.getElementById('imageFieldsContainer').innerHTML='';
            }
        }

        // ---- إدارة topics.json تلقائيًا ----
        let cachedTopics=[];
        let topicsSha=null;

        async function loadTopics(){
            const resDiv=document.getElementById('topicsResult');
            resDiv.textContent='Loading topics.json...';
            try {
                const res=await fetch('/api/topics');
                const json=await res.json();
                if(!json.success){
                    resDiv.textContent='Error: '+json.error;
                    return;
                }
                cachedTopics=json.topics;
                topicsSha=json.sha;
                resDiv.textContent='Loaded topics.json (sha='+json.sha+').';
                renderTopicsUI();
            } catch(err){
                resDiv.textContent='Error: '+err;
            }
        }
        function renderTopicsUI(){
            const container=document.getElementById('topicsContainer');
            container.innerHTML='';
            if(!Array.isArray(cachedTopics))return;
            cachedTopics.forEach((t,idx)=>{
                const div=document.createElement('div');
                div.classList.add('topic-item');
                div.innerHTML=`
                    <strong>${t.topicName}</strong> (subTopics: ${t.subTopics ? t.subTopics.length : 0})<br>
                    ${t.description||''}
                `;
                // delete button
                const delBtn=document.createElement('button');
                delBtn.textContent='Delete';
                delBtn.classList.add('btn-del');
                delBtn.onclick=()=>{
                    if(confirm('Delete this topic?')){
                        cachedTopics.splice(idx,1);
                        renderTopicsUI();
                    }
                };
                div.appendChild(delBtn);
                // edit button
                const editBtn=document.createElement('button');
                editBtn.textContent='Edit';
                editBtn.classList.add('btn-edit');
                editBtn.onclick=()=>{
                    const newName=prompt('Topic name:', t.topicName);
                    if(newName) t.topicName=newName;
                    const newDesc=prompt('Topic description:', t.description||'');
                    if(newDesc!==null) t.description=newDesc;
                    renderTopicsUI();
                };
                div.appendChild(editBtn);

                // subtopics
                if(t.subTopics && t.subTopics.length>0){
                    const ul=document.createElement('ul');
                    ul.classList.add('subtopic-list');
                    t.subTopics.forEach((st, stidx)=>{
                        const li=document.createElement('li');
                        li.textContent=`${st.name} -> ${st.file}`;
                        // delete
                        const sdel=document.createElement('button');
                        sdel.textContent='X';
                        sdel.classList.add('btn-del');
                        sdel.style.marginLeft='10px';
                        sdel.onclick=()=>{
                            if(confirm('Delete subtopic?')){
                                t.subTopics.splice(stidx,1);
                                renderTopicsUI();
                            }
                        };
                        li.appendChild(sdel);
                        // edit
                        const sedit=document.createElement('button');
                        sedit.textContent='Edit';
                        sedit.classList.add('btn-edit');
                        sedit.onclick=()=>{
                            const nn=prompt('Subtopic name:', st.name);
                            if(nn) st.name=nn;
                            const nf=prompt('Subtopic file:', st.file);
                            if(nf) st.file=nf;
                            renderTopicsUI();
                        };
                        li.appendChild(sedit);

                        ul.appendChild(li);
                    });
                    div.appendChild(ul);
                }
                // add subtopic
                const addSt=document.createElement('button');
                addSt.textContent='Add Subtopic';
                addSt.style.marginTop='5px';
                addSt.onclick=()=>{
                    const nm=prompt('Subtopic name?');
                    if(!nm)return;
                    const fl=prompt('Subtopic file path? (like data/cns_anatomy.json)');
                    if(!fl)return;
                    if(!t.subTopics) t.subTopics=[];
                    t.subTopics.push({name:nm, file:fl});
                    renderTopicsUI();
                };
                div.appendChild(addSt);

                container.appendChild(div);
            });
        }
        async function saveTopics(){
            const resDiv=document.getElementById('topicsResult');
            if(!topicsSha){
                resDiv.textContent='No loaded topics.json to save.';
                return;
            }
            try {
                const body={ topics: cachedTopics, sha: topicsSha };
                const res=await fetch('/api/topics',{
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify(body)
                });
                const json=await res.json();
                if(!json.success){
                    resDiv.textContent='Error: '+json.error;
                    return;
                }
                resDiv.textContent='Saved topics.json. commit='+JSON.stringify(json.commit);
            } catch(err){
                resDiv.textContent='Error: '+err;
            }
        }
        function addTopic(){
            const name=document.getElementById('newTopicName').value.trim();
            const desc=document.getElementById('newTopicDesc').value.trim();
            if(!name){
                alert('Enter topic name');
                return;
            }
            cachedTopics.push({
                topicName:name,
                description:desc,
                subTopics:[]
            });
            document.getElementById('newTopicName').value='';
            document.getElementById('newTopicDesc').value='';
            renderTopicsUI();
        }
    </script>
</body>
</html>

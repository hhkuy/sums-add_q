<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Converter + Subtopic Manager (No Logs, Updated Upload)</title>
  <style>
    body {
      margin:0; padding:20px; background:#f0f2f5;
      font-family:sans-serif; color:#333;
    }
    .container {
      max-width:1200px; margin:0 auto; background:#fff; padding:20px;
      border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align:center; color:#4a90e2; margin-bottom:20px;
      font-size:28px;
    }
    .section {
      background:#f9f9f9; border:1px solid #ccc; border-radius:5px; padding:15px; margin-bottom:20px;
    }
    .section h2 {
      color:#4a90e2; margin-top:0; margin-bottom:10px; font-size:22px;
    }
    button {
      padding:12px 24px; border:none; border-radius:4px; cursor:pointer;
      margin-right:5px; margin-top:5px; font-size:16px;
    }
    button:hover {opacity:0.9;}
    .btn-blue { background:#4a90e2; color:#fff; }
    .btn-red { background:#dc3545; color:#fff; }
    .btn-orange { background:#ff9800; color:#fff; }
    .btn-green { background:#28a745; color:#fff; }
    /* زر الرجوع للمواضيع بلون رمادي فاتح */
    #back-to-topics {
      background:#d3d3d3; 
      color:#000;
    }

    input[type="text"], input[type="number"], textarea, select {
      width:100%; padding:12px; margin-bottom:8px;
      border:1px solid #ccc; border-radius:4px; font-size:16px;
    }
    #topicsList, #subtopicQuestions {
      background:#fff; border:1px solid #ccc; border-radius:4px; padding:10px; min-height:60px; margin-top:10px;
    }
    .image-field-row {
      display:flex; align-items:center; gap:10px; margin-bottom:8px;
    }
    .progress {
      width:100%; background:#e0e0e0; border-radius:5px; overflow:hidden; height:24px; display:none;
    }
    .progress-bar {
      background:#4a90e2; height:100%; width:0%; color:#fff; text-align:center; line-height:24px;
      transition:width 0.3s; font-size:14px;
    }
    .q-item {
      border:1px solid #ccc; padding:8px; border-radius:4px; margin-bottom:5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Quiz Converter + Subtopic Manager</h1>

    <!-- Manage Topics -->
    <div class="section">
      <h2>Manage Topics (data/topics.json)</h2>
      <button class="btn-blue" onclick="loadTopics()">Load topics.json</button>
      <button class="btn-blue" onclick="saveTopics()">Save topics.json</button>
      <div id="topicsList"></div>

      <h3 style="margin-top:15px; font-size:18px;">Add New Topic</h3>
      <input type="text" id="newTopicName" placeholder="Topic Name...">
      <input type="text" id="newTopicDesc" placeholder="Topic Description...">
      <button class="btn-blue" onclick="addTopic()">Add Topic</button>
    </div>

    <!-- Subtopic Manager -->
    <div class="section">
      <h2>Subtopic Questions Manager</h2>
      <p>Select a subtopic after loading topics, then load or save its questions.</p>
      <select id="subtopicSelect"></select>
      <div style="margin-top:10px;">
        <button class="btn-blue" onclick="loadSubtopic()">Load Questions</button>
        <button class="btn-blue" onclick="saveSubtopic()">Save Questions</button>
        <!-- زر الرجوع للمواضيع بلون رمادي فاتح -->
        <button id="back-to-topics" onclick="alert('Back to topics clicked!')">Back to Topics</button>
      </div>
      <div id="subtopicQuestions"></div>

      <h3 style="margin-top:20px; font-size:18px;">Add New Questions (Convert & Append)</h3>
      <label>Prefix (optional):</label>
      <input type="text" id="prefixInput" placeholder="e.g. Dr. Ali -">

      <label>Questions Text (larger box):</label>
      <textarea id="questionsText" rows="8" style="font-size:16px;"></textarea>

      <button class="btn-orange" style="margin-top:5px;" onclick="addImageField()">Add Image Field</button>
      <div id="imageContainer" style="margin-top:10px;"></div>

      <button class="btn-blue" style="margin-top:10px;" onclick="convertAndAppend()">Convert & Append</button>

      <h3 style="margin-top:20px; font-size:18px;">Delete Questions by Bold Prefix</h3>
      <input type="text" id="deletePrefix" placeholder="e.g. Dr. Golshan">
      <button class="btn-red" onclick="deleteByPrefix()">Delete</button>
    </div>
  </div>

<script>
let cachedTopics=[];
let topicsSha=null;

// subtopic
let currentSubtopicPath=null;
let currentSubtopicSha=null;
let currentQuestions=[];

// ============ Manage Topics ============
async function loadTopics(){
  try {
    const r=await fetch('/api/topics');
    const j=await r.json();
    if(!j.success){ alert('Error: '+ j.error); return; }
    cachedTopics=j.topics;
    topicsSha=j.sha;
    alert(`Loaded topics.json (sha=${j.sha}). Found ${cachedTopics.length} topics.`);
    renderTopics();
    fillSubtopics();
  } catch(err){
    alert('Error: '+err);
  }
}

function renderTopics(){
  const list=document.getElementById('topicsList');
  list.innerHTML='';
  cachedTopics.forEach((t,idx)=>{
    const div=document.createElement('div');
    div.style.border='1px solid #ccc';
    div.style.padding='8px';
    div.style.borderRadius='4px';
    div.style.marginBottom='8px';
    div.innerHTML=`
      <strong>${t.topicName}</strong> (sub:${t.subTopics?t.subTopics.length:0})<br>
      ${t.description||''}
    `;
    const del=document.createElement('button');
    del.textContent='Delete';
    del.classList.add('btn-red');
    del.onclick=()=>{
      if(confirm('Delete this topic?')){
        cachedTopics.splice(idx,1);
        renderTopics();
        fillSubtopics();
      }
    };
    div.appendChild(del);

    const ed=document.createElement('button');
    ed.textContent='Edit';
    ed.classList.add('btn-orange');
    ed.onclick=()=>{
      const nn=prompt('Topic name:', t.topicName);
      if(nn) t.topicName=nn;
      const nd=prompt('Topic desc:', t.description||'');
      if(nd!==null) t.description=nd;
      renderTopics();
      fillSubtopics();
    };
    div.appendChild(ed);

    if(t.subTopics && t.subTopics.length>0){
      t.subTopics.forEach((st,stidx)=>{
        const stDiv=document.createElement('div');
        stDiv.style.marginLeft='15px';
        stDiv.style.marginTop='5px';
        stDiv.textContent=`${st.name} => ${st.file||''} `;
        const sdel=document.createElement('button');
        sdel.textContent='X';
        sdel.classList.add('btn-red');
        sdel.onclick=()=>{
          if(confirm('Delete subtopic?')){
            t.subTopics.splice(stidx,1);
            renderTopics();
            fillSubtopics();
          }
        };
        stDiv.appendChild(sdel);

        const sedit=document.createElement('button');
        sedit.textContent='Edit';
        sedit.classList.add('btn-orange');
        sedit.onclick=()=>{
          const rename=prompt('Subtopic name:', st.name);
          if(rename){
            st.name=rename;
            renderTopics();
            fillSubtopics();
          }
        };
        stDiv.appendChild(sedit);

        div.appendChild(stDiv);
      });
    }
    const addSt=document.createElement('button');
    addSt.textContent='Add Subtopic';
    addSt.classList.add('btn-blue');
    addSt.onclick=()=>{
      const sn=prompt('Subtopic name?');
      if(!sn)return;
      const fileName=(t.topicName.replace(/\s+/g,'_')+"_"+sn.replace(/\s+/g,'_')).toLowerCase()+'.json';
      const path='data/'+fileName;
      if(!t.subTopics) t.subTopics=[];
      t.subTopics.push({name:sn, file:path});
      renderTopics();
      fillSubtopics();
    };
    div.appendChild(addSt);

    list.appendChild(div);
  });
}

async function saveTopics(){
  if(!topicsSha){
    alert('No topics loaded');
    return;
  }
  try{
    const body={ topics:cachedTopics, sha:topicsSha };
    const r=await fetch('/api/topics',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!j.success){ alert('Error: '+j.error); return;}
    alert('Saved topics.json. commit='+JSON.stringify(j.commit));
  }catch(err){
    alert('Error: '+err);
  }
}

function addTopic(){
  const nm=document.getElementById('newTopicName').value.trim();
  const ds=document.getElementById('newTopicDesc').value.trim();
  if(!nm){ alert('Enter topic name'); return; }
  cachedTopics.push({
    topicName:nm,
    description:ds,
    subTopics:[]
  });
  document.getElementById('newTopicName').value='';
  document.getElementById('newTopicDesc').value='';
  renderTopics();
  fillSubtopics();
}

// ============ Subtopic Manager ============
function fillSubtopics(){
  const sel=document.getElementById('subtopicSelect');
  sel.innerHTML='';
  cachedTopics.forEach(t=>{
    if(t.subTopics){
      t.subTopics.forEach(st=>{
        const opt=document.createElement('option');
        opt.value=st.file;
        opt.textContent=`[${t.topicName}] - ${st.name}`;
        sel.appendChild(opt);
      });
    }
  });
}

async function loadSubtopic(){
  const sel=document.getElementById('subtopicSelect');
  if(!sel.value){
    alert('No subtopic selected');
    return;
  }
  currentSubtopicPath=sel.value;
  try{
    const r=await fetch('/api/get-subtopic-file?path='+encodeURIComponent(currentSubtopicPath));
    const j=await r.json();
    if(!j.success){ alert('Error: '+ j.error); return;}
    currentSubtopicSha=j.sha;
    currentQuestions=j.content;
    alert(`Loaded subtopic file: ${currentSubtopicPath} (sha=${j.sha}), found ${currentQuestions.length} questions.`);
    renderSubtopicQuestions();
  }catch(err){
    alert('Error: '+err);
  }
}

function renderSubtopicQuestions(){
  const box=document.getElementById('subtopicQuestions');
  box.innerHTML='';
  currentQuestions.forEach((q, idx)=>{
    const div=document.createElement('div');
    div.classList.add('q-item');
    let shortQ=q.question? q.question.substring(0,60) : "No question text";
    div.textContent=`[${idx}] => ${shortQ}... `;
    // delete
    const del=document.createElement('button');
    del.textContent='Delete';
    del.classList.add('btn-red');
    del.style.marginLeft='5px';
    del.onclick=()=>{
      if(confirm('Delete this question?')){
        currentQuestions.splice(idx,1);
        renderSubtopicQuestions();
      }
    };
    div.appendChild(del);
    box.appendChild(div);
  });
}

async function saveSubtopic(){
  if(!currentSubtopicPath){
    alert('No subtopic selected');
    return;
  }
  try{
    const body={
      path:currentSubtopicPath,
      content:currentQuestions,
      sha: currentSubtopicSha
    };
    const r=await fetch('/api/update-subtopic-file',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!j.success){ alert('Error: '+j.error); return; }
    alert('Saved subtopic file. commit='+JSON.stringify(j.commit));
  } catch(err){
    alert('Error: '+err);
  }
}

// إضافة حقل صورة
function addImageField(){
  const container=document.getElementById('imageContainer');
  const row=document.createElement('div');
  row.classList.add('image-field-row');

  const qNum=document.createElement('input');
  qNum.type='number';
  qNum.placeholder='Q#';
  qNum.min=1;

  const fileIn=document.createElement('input');
  fileIn.type='file';
  fileIn.accept='image/*';

  const delBtn=document.createElement('button');
  delBtn.textContent='Remove';
  delBtn.classList.add('btn-orange');
  delBtn.onclick=()=> container.removeChild(row);

  const prog=document.createElement('div');
  prog.classList.add('progress');
  const pbar=document.createElement('div');
  pbar.classList.add('progress-bar');
  pbar.textContent='0%';
  prog.appendChild(pbar);

  row.appendChild(qNum);
  row.appendChild(fileIn);
  row.appendChild(delBtn);
  row.appendChild(prog);
  container.appendChild(row);
}

// تحويل النص + رفع الصور وإدراجها
async function convertAndAppend(){
  if(!currentSubtopicPath){
    alert('No subtopic selected to append questions');
    return;
  }
  let prefix=document.getElementById('prefixInput').value.trim();
  let text=document.getElementById('questionsText').value.trim();
  if(!text){
    alert('No questions text');
    return;
  }

  // 1) جرّب parse JSON
  let arr=null;
  try {
    if(text.startsWith('let quizData =')){
      text=text.replace('let quizData =','').trim();
      if(text.endsWith(';')) text=text.slice(0,-1);
    }
    arr=JSON.parse(text);
    if(Array.isArray(arr)){
      // ادمج الصور
      await handleImagesAndBind(arr);
      currentQuestions=currentQuestions.concat(arr);
      alert(`Appended ${arr.length} questions (JSON). Now total ${currentQuestions.length}`);
      renderSubtopicQuestions();
      return;
    }
  }catch(e){
    // نستمر للتنسيق النصي
  }

  // 2) تنسيق نصي
  const lines=text.split('\n');
  let questionText=null, options=[], answerIdx=-1, answerText=null, explanation=null;
  let out=[];
  for(let i=0;i<lines.length;i++){
    let ln=lines[i].trim();
    let qM=ln.match(/^(\d+)\.\s+(.*)/);
    if(qM){
      if(questionText!==null){
        out.push({
          question:questionText,
          options, answer:answerIdx, answerText, explanation,
          userAnswer:null
        });
      }
      let qn=parseInt(qM[1],10);
      questionText=`<span style='color: darkred; font-weight:bold;'>${prefix? prefix+' ':''}Question ${qn}</span> ${qM[2]}`;
      options=[]; answerIdx=-1; answerText=null; explanation=null;
    } else {
      let opt=ln.match(/^([A-F])\.\s+(.*)/i);
      if(opt){
        let txt=opt[2].trim();
        if(txt.endsWith('***')){
          txt=txt.slice(0,-3).trim();
          answerIdx=options.length;
          answerText=txt;
        }
        options.push(txt);
      } else {
        let ex=ln.match(/^Explanation\s*:\s*(.*)/i);
        if(ex){
          explanation=ex[1];
        }
      }
    }
  }
  if(questionText!==null){
    out.push({
      question:questionText,
      options, answer:answerIdx, answerText, explanation,
      userAnswer:null
    });
  }

  // رفع الصور ودمجها
  await handleImagesAndBind(out);
  currentQuestions=currentQuestions.concat(out);
  alert(`Converted & appended ${out.length} questions. Now total: ${currentQuestions.length}`);
  renderSubtopicQuestions();
}

/**
 * رفع كل الصور وإضافة رابط الصورة في السؤال المناسب
 */
async function handleImagesAndBind(questionsArr){
  const container=document.getElementById('imageContainer');
  const rows=container.querySelectorAll('.image-field-row');
  for(const row of rows){
    const inputs=row.querySelectorAll('input');
    const qNum=parseInt(inputs[0].value,10);
    if(!qNum) continue;
    const fileIn=inputs[1];
    if(fileIn.files && fileIn.files.length>0){
      let file=fileIn.files[0];
      const prog=row.querySelector('.progress');
      const pbar=prog.querySelector('.progress-bar');
      let url=await uploadImageToImgHippo(file, prog, pbar); // ← الدالة الجديدة

      if(url){
        // ندمجه في السؤال المطابق qNum
        for(let q of questionsArr){
          let match=q.question.match(/Question\s+(\d+)/);
          if(match){
            let num=parseInt(match[1],10);
            if(num===qNum){
              q.question+=`<br><img src='${url}' alt='Image for Question ${qNum}' style='max-width: 100%; height: auto;'>`;
              break;
            }
          }
        }
      }
    }
  }
}

/**
 * الدالة الجديدة لرفع الصورة إلى imghippo بنفس منطق الكود المرسل
 */
function uploadImageToImgHippo(file, progressBarContainer, progressBar) {
  return new Promise((resolve) => {
    if (!file) {
      return resolve("");
    }

    // إظهار شريط التقدم
    if (progressBarContainer) {
      progressBarContainer.style.display = "block";
    }
    if (progressBar) {
      progressBar.style.width = "0%";
      progressBar.textContent = "0%";
    }

    let formData = new FormData();
    formData.append("api_key", "076dd2c00a3cf16634d6029f1b25b16c"); // مفتاح API
    formData.append("file", file);

    let xhr = new XMLHttpRequest();
    xhr.open("POST", "https://api.imghippo.com/v1/upload", true);
    xhr.setRequestHeader("Accept", "application/json");

    xhr.upload.onprogress = function(event) {
      if (event.lengthComputable) {
        const percentComplete = Math.floor((event.loaded / event.total) * 100);
        if (progressBar) {
          progressBar.style.width = percentComplete + "%";
          progressBar.setAttribute("aria-valuenow", percentComplete);
          progressBar.textContent = percentComplete + "%";
        }
      }
    };

    xhr.onload = function() {
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.success && response.data && response.data.url) {
            if (progressBar) {
              progressBar.style.width = "100%";
              progressBar.textContent = "تم رفع الصورة";
            }
            return resolve(response.data.url);
          } else {
            console.error("فشل رفع الصورة:", response);
            if (progressBar) {
              progressBar.textContent = "فشل الرفع";
            }
            return resolve("");
          }
        } catch (error) {
          console.error("خطأ في تحليل الاستجابة:", error);
          if (progressBar) {
            progressBar.textContent = "فشل الرفع";
          }
          return resolve("");
        }
      } else {
        console.error("فشل الرفع. حالة الطلب:", xhr.status);
        if (progressBar) {
          progressBar.textContent = "فشل الرفع";
        }
        return resolve("");
      }
    };

    xhr.onerror = function() {
      console.error("حدث خطأ أثناء الاتصال.");
      if (progressBar) {
        progressBar.textContent = "فشل الرفع";
      }
      return resolve("");
    };

    xhr.send(formData);
  });
}

// حذف الأسئلة بكلام غامق
async function deleteByPrefix(){
  if(!currentSubtopicPath){
    alert('No subtopic loaded');
    return;
  }
  const p=document.getElementById('deletePrefix').value.trim();
  if(!p){
    alert('Enter prefix');
    return;
  }
  if(!currentSubtopicSha && currentQuestions.length===0){
    alert("No existing subtopic file or questions to delete from");
    return;
  }
  try{
    const body={ path: currentSubtopicPath, sha: currentSubtopicSha, prefix:p };
    const r=await fetch('/api/delete-questions-by-prefix',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const j=await r.json();
    if(!j.success){
      alert("Error: "+j.error);
      return;
    }
    alert(`Deleted ${j.deletedCount} questions with prefix '${p}'. Reloading subtopic...`);
    loadSubtopic();
  }catch(err){
    alert("Error: "+err);
  }
}

/** تنسيق التوقيت (24-->12) */
function formatTo12Hour(timeVal) {
  if (!timeVal) return "";
  let [hh, mm] = timeVal.split(":");
  hh = parseInt(hh, 10);
  let period = (hh >= 12) ? "م" : "ص";
  let newH = (hh % 12) || 12;
  return newH + ":" + mm + " " + period;
}
</script>
</body>
</html>
